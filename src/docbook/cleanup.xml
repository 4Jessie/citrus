<?xml version="1.0" encoding="UTF-8"?>
<chapter id="cleanup">
    <title>Test case cleanup</title>

    <para>When dealing with database access, we might run into some problems in case the test fails. 
    Imagine that you have prepared some data inside the database at the beginning of your test and 
    you want to make sure that the data is cleaned up at the end of the test case. Now we have the problem
    that in case of an error the whole test case will terminate immediately. Cleanup tasks at the end of the 
    test may not be executed correctly.</para>
    
    <para>This dirty state in database might cause problems for upcoming test cases. To avoid this problems 
    you should use the cleanup block inside the test case. The &lt;cleanup&gt; section contains actions that 
    are executed even in case the test fails. Using this strategy the database cleaning tasks mentioned before
    will find execution in every case (success or failure).</para>
    
    <para>The following example shows how to use the cleanup section at the end of a test:</para>
  
    <programlisting>
  &lt;testcase name=&quot;finallyBlockTest_new&quot;&gt;
      &lt;variables&gt;
          &lt;variable name=&quot;orderId&quot; value=&quot;1&quot;/&gt;
          &lt;variable name=&quot;date&quot; 
                       value=&quot;citrus:currentDate('dd.MM.yyyy')&quot;/&gt;
      &lt;/variables&gt;
      &lt;actions&gt;
          &lt;updateDatabase connect=&quot;databaseAccess&quot;&gt;
              &lt;statement&gt;
                  INSERT INTO ORDERS VALUES (${orderId}, 1, 1, '${date}')
              &lt;/statement&gt;
          &lt;/updateDatabase&gt;
          
          &lt;echo&gt;
              &lt;message&gt;
                  ORDER creation time: ${date}
              &lt;/message&gt;
          &lt;/echo&gt;
      &lt;/actions&gt;
      &lt;cleanup&gt;
          &lt;updateDatabase connect=&quot;databaseAccess&quot;&gt;
              &lt;statement&gt;DELETE FROM ORDERS WHERE ORDER_ID='${orderId}'&lt;/statement&gt;
          &lt;/updateDatabase&gt;
      &lt;/cleanup&gt;
  &lt;/testcase&gt;
    </programlisting>
    
    <para>In the example the first action creates an order in the database using an INSERT SQL statement. To be sure that the 
    order in the database is deleted after the test, the cleanup section contains the respective database DELETE action.</para>
    
</chapter>